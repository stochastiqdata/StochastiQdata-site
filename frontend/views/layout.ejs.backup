<!DOCTYPE html>
<html lang="fr" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StochastiQdata - Datasets pour Actuaires</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/logo.png">
</head>
<body class="bg-mesh min-h-screen transition-colors duration-300">
  <!-- Background decorations -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-[500px] h-[500px] bg-gradient-to-br from-pink-500/20 to-purple-600/20 dark:from-pink-500/30 dark:to-purple-600/30 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-40 -left-40 w-[500px] h-[500px] bg-gradient-to-tr from-teal-400/20 to-cyan-500/20 dark:from-teal-400/30 dark:to-cyan-500/30 rounded-full blur-3xl"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-r from-indigo-500/10 to-purple-500/10 dark:from-indigo-500/20 dark:to-purple-500/20 rounded-full blur-3xl"></div>
  </div>

  <div class="relative flex min-h-screen">
    <!-- Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main Content Area -->
    <div class="flex-1 ml-72 p-6">
      <!-- Header -->
      <%- include('partials/header') %>

      <!-- Page Content -->
      <main class="mt-6">
        <%- body %>
      </main>
    </div>
  </div>

  <!-- Clerk Script - Chargement optimisé -->
  <script>
    // Précharger les fonctions UI immédiatement
    window.openSignIn = () => console.log('Clerk loading...');
    window.openSignUp = () => console.log('Clerk loading...');
    window.getAuthToken = () => Promise.resolve(null);
    window.isUserLoggedIn = () => false;
  </script>

  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="<%= clerkPublishableKey %>"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    type="text/javascript"
    onload="initializeClerk()"
  ></script>

  <script>
    // ============================================
    // CLERK AUTHENTICATION - Optimisé
    // ============================================
    let clerk = null;
    let clerkReady = false;

    async function initializeClerk() {
      // Wait for Clerk to be available
      if (window.Clerk) {
        try {
          clerk = window.Clerk;
          await clerk.load({
            localization: {
              signUp: {
                start: {
                  title: 'Créer votre compte',
                  subtitle: 'Bienvenue ! Veuillez remplir les informations pour commencer.',
                  actionText: 'Vous avez déjà un compte ?',
                  actionLink: 'Se connecter'
                },
                emailLink: {
                  title: 'Vérifiez votre email',
                  subtitle: 'pour continuer vers {{applicationName}}',
                  formTitle: 'Lien de vérification',
                  formSubtitle: 'Utilisez le lien envoyé à votre adresse email',
                  resendButton: 'Renvoyer le lien',
                  verified: {
                    title: 'Inscription réussie'
                  }
                },
                emailCode: {
                  title: 'Vérifiez votre email',
                  subtitle: 'pour continuer vers {{applicationName}}',
                  formTitle: 'Code de vérification',
                  formSubtitle: 'Entrez le code envoyé à votre adresse email',
                  resendButton: 'Renvoyer le code'
                },
                continue: {
                  title: 'Complétez les champs manquants',
                  subtitle: 'pour continuer vers {{applicationName}}',
                  actionText: 'Vous avez déjà un compte ?',
                  actionLink: 'Se connecter'
                }
              },
              signIn: {
                start: {
                  title: 'Se connecter',
                  subtitle: 'Bienvenue ! Veuillez vous connecter pour continuer.',
                  actionText: 'Pas encore de compte ?',
                  actionLink: 'Créer un compte'
                },
                password: {
                  title: 'Entrez votre mot de passe',
                  subtitle: 'pour continuer vers {{applicationName}}',
                  actionLink: 'Utiliser une autre méthode'
                },
                forgotPasswordLink: 'Mot de passe oublié ?',
                emailCode: {
                  title: 'Vérifiez votre email',
                  subtitle: 'pour continuer vers {{applicationName}}',
                  formTitle: 'Code de vérification',
                  formSubtitle: 'Entrez le code envoyé à votre adresse email',
                  resendButton: 'Renvoyer le code'
                }
              },
              userProfile: {
                start: {
                  headerTitle__account: 'Compte',
                  headerTitle__security: 'Sécurité',
                  profileSection: {
                    title: 'Profil'
                  },
                  usernameSection: {
                    title: "Nom d'utilisateur"
                  },
                  emailAddressesSection: {
                    title: 'Adresses email'
                  },
                  passwordSection: {
                    title: 'Mot de passe'
                  },
                  activeDevicesSection: {
                    title: 'Appareils actifs'
                  }
                }
              },
              formFieldLabel__firstName: 'Prénom',
              formFieldLabel__lastName: 'Nom',
              formFieldLabel__emailAddress: 'Adresse email',
              formFieldLabel__password: 'Mot de passe',
              formFieldLabel__confirmPassword: 'Confirmer le mot de passe',
              formFieldLabel__username: "Nom d'utilisateur",
              formFieldInputPlaceholder__firstName: 'Prénom',
              formFieldInputPlaceholder__lastName: 'Nom',
              formFieldInputPlaceholder__emailAddress: 'Entrez votre adresse email',
              formFieldInputPlaceholder__password: 'Entrez votre mot de passe',
              formFieldInputPlaceholder__confirmPassword: 'Confirmez votre mot de passe',
              formFieldInputPlaceholder__username: "Entrez votre nom d'utilisateur",
              formButtonPrimary: 'Continuer',
              formFieldAction__forgotPassword: 'Mot de passe oublié ?',
              socialButtonsBlockButton: 'Continuer avec {{provider}}',
              dividerText: 'ou',
              footerActionLink__useAnotherMethod: 'Utiliser une autre méthode',
              badge__primary: 'Principal',
              badge__thisDevice: 'Cet appareil',
              badge__userDevice: 'Appareil utilisateur',
              badge__otherImpersonatorDevice: 'Autre appareil',
              badge__default: 'Par défaut',
              badge__unverified: 'Non vérifié',
              badge__requiresAction: 'Action requise',
              badge__you: 'Vous',
              footerPageLink__help: 'Aide',
              footerPageLink__privacy: 'Confidentialité',
              footerPageLink__terms: 'Conditions',
              signInButton: 'Se connecter',
              signUpButton: "S'inscrire",
              backButton: 'Retour',
              unstable__errors: {
                form_identifier_not_found: 'Compte non trouvé. Veuillez vérifier vos informations.',
                form_password_incorrect: 'Mot de passe incorrect. Veuillez réessayer.',
                form_password_validation_failed: 'Le mot de passe ne respecte pas les critères requis.',
                form_code_incorrect: 'Code incorrect. Veuillez réessayer.',
                not_allowed_access: "Accès non autorisé.",
                form_identifier_exists: 'Cette adresse email est déjà utilisée.'
              }
            }
          });

          clerkReady = true;
          console.log('Clerk loaded successfully');

          // Update UI based on auth state
          updateUserUI();

          // Listen for auth changes
          clerk.addListener((event) => {
            updateUserUI();
          });
        } catch (e) {
          console.error('Failed to load Clerk:', e);
        }
      } else {
        console.warn('Clerk not available - check your publishable key');
      }
    }

    // Fallback si Clerk ne se charge pas automatiquement
    if (typeof window !== 'undefined') {
      window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          if (!clerkReady && window.Clerk) {
            initializeClerk();
          }
        }, 100);
      });
    }

    // Open Sign In modal - Optimisé
    async function openSignIn() {
      if (clerk && clerkReady) {
        clerk.openSignIn({
          afterSignInUrl: window.location.href,
          afterSignUpUrl: window.location.href
        });
      } else {
        // Attendre que Clerk soit chargé (max 3 secondes)
        const maxWait = 3000;
        const startTime = Date.now();
        while (!clerkReady && (Date.now() - startTime) < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        if (clerk && clerkReady) {
          clerk.openSignIn({
            afterSignInUrl: window.location.href,
            afterSignUpUrl: window.location.href
          });
        } else {
          alert('Authentification en cours de chargement. Veuillez patienter un instant.');
        }
      }
    }

    // Open Sign Up modal - Optimisé
    async function openSignUp() {
      if (clerk && clerkReady) {
        clerk.openSignUp({
          afterSignInUrl: window.location.href,
          afterSignUpUrl: window.location.href
        });
      } else {
        // Attendre que Clerk soit chargé (max 3 secondes)
        const maxWait = 3000;
        const startTime = Date.now();
        while (!clerkReady && (Date.now() - startTime) < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        if (clerk && clerkReady) {
          clerk.openSignUp({
            afterSignInUrl: window.location.href,
            afterSignUpUrl: window.location.href
          });
        } else {
          alert('Authentification en cours de chargement. Veuillez patienter un instant.');
        }
      }
    }

    // Sign out - Version simplifiée qui fonctionne
    async function signOut() {
      if (!clerk) {
        console.error('Clerk not loaded');
        return;
      }

      try {
        // Déconnexion simple de Clerk
        await clerk.signOut();

        // Redirection vers l'accueil
        window.location.href = '/';
      } catch (error) {
        console.error('Sign out error:', error);
        // En cas d'erreur, forcer le reload
        window.location.href = '/';
      }
    }

    // Helper function: Fetch avec authentification Clerk
    async function fetchWithAuth(url, options = {}) {
      if (!clerk || !clerk.session) {
        // Pas de session Clerk, requête normale sans auth
        return fetch(url, options);
      }

      try {
        // Récupérer le token JWT de Clerk
        const token = await clerk.session.getToken();

        // Ajouter le token dans les headers
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`
        };

        return fetch(url, options);
      } catch (error) {
        console.error('Error getting Clerk token:', error);
        // En cas d'erreur, requête sans auth
        return fetch(url, options);
      }
    }

    // Exposer fetchWithAuth globalement
    window.fetchWithAuth = fetchWithAuth;

    // Update UI based on user state
    function updateUserUI() {
      const userSection = document.getElementById('user-section');
      const headerUserSection = document.getElementById('header-user-section');

      if (clerk && clerk.user) {
        // User is signed in
        const user = clerk.user;
        const displayName = user.fullName || user.firstName || user.emailAddresses[0]?.emailAddress?.split('@')[0] || 'Utilisateur';
        const avatarUrl = user.imageUrl || '/images/default-avatar.png';
        const email = user.emailAddresses[0]?.emailAddress || '';

        // Update sidebar
        if (userSection) {
          userSection.innerHTML = `
            <a href="/profile" class="flex items-center gap-3 p-3 rounded-xl bg-navy-700/50 hover:bg-navy-700 transition-all mb-2">
              <img src="${avatarUrl}"
                   alt="${displayName}"
                   class="w-10 h-10 rounded-full object-cover border-2 border-primary-500"
                   onerror="this.src='/images/default-avatar.png'">
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">${displayName}</p>
                <p class="text-xs text-gray-400 truncate">${email}</p>
              </div>
            </a>
            <button onclick="if(window.clerk){window.clerk.signOut().then(()=>window.location.href='/').catch(()=>window.location.href='/')}" class="w-full flex items-center justify-center gap-2 py-2.5 px-3 text-sm font-medium text-gray-400 hover:text-white bg-navy-700/30 hover:bg-navy-700 rounded-xl transition-all">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
              Déconnexion
            </button>
          `;
        }

        // Update header
        if (headerUserSection) {
          headerUserSection.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${avatarUrl}"
                   alt="${displayName}"
                   class="w-9 h-9 rounded-full object-cover border-2 border-primary-500 cursor-pointer hover:border-primary-400 transition-all"
                   onclick="window.location.href='/profile'"
                   onerror="this.src='/images/default-avatar.png'"
                   title="Mon profil">
              <button onclick="if(window.clerk){window.clerk.signOut().then(()=>window.location.href='/').catch(()=>window.location.href='/')}" class="btn-outline text-sm" title="Se déconnecter">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <polyline points="16 17 21 12 16 7"/>
                  <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                <span class="hidden sm:inline">Déconnexion</span>
              </button>
            </div>
          `;
        }
      } else {
        // User is signed out
        if (userSection) {
          userSection.innerHTML = `
            <button onclick="openSignIn()" class="w-full flex items-center justify-center gap-2 py-2.5 px-4 text-sm font-medium text-gray-300 hover:text-white bg-navy-700 hover:bg-navy-600 rounded-xl transition-all">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                <polyline points="10 17 15 12 10 7"/>
                <line x1="15" y1="12" x2="3" y2="12"/>
              </svg>
              Se connecter
            </button>
            <button onclick="openSignUp()" class="mt-2 w-full flex items-center justify-center gap-2 py-2.5 px-4 text-sm font-medium text-white bg-gradient-to-r from-primary-500 to-teal-500 hover:from-primary-600 hover:to-teal-600 rounded-xl transition-all shadow-lg">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <line x1="19" y1="8" x2="19" y2="14"/>
                <line x1="22" y1="11" x2="16" y2="11"/>
              </svg>
              Créer un compte
            </button>
          `;
        }

        if (headerUserSection) {
          headerUserSection.innerHTML = `
            <button class="btn-primary" onclick="openSignIn()">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                <polyline points="10 17 15 12 10 7"/>
                <line x1="15" y1="12" x2="3" y2="12"/>
              </svg>
              <span class="hidden sm:inline">Se connecter</span>
            </button>
          `;
        }
      }
    }

    // Get session token for API calls - Optimisé avec cache
    let tokenCache = null;
    let tokenCacheTime = 0;
    const TOKEN_CACHE_DURATION = 60000; // 1 minute

    async function getAuthToken() {
      // Utiliser le cache si disponible et valide
      if (tokenCache && (Date.now() - tokenCacheTime) < TOKEN_CACHE_DURATION) {
        return tokenCache;
      }

      if (clerk && clerk.session) {
        tokenCache = await clerk.session.getToken();
        tokenCacheTime = Date.now();
        return tokenCache;
      }
      return null;
    }

    // Check if user is logged in - Optimisé
    function isUserLoggedIn() {
      return clerkReady && clerk && clerk.user;
    }

    // Expose functions globally
    window.openSignIn = openSignIn;
    window.openSignUp = openSignUp;
    window.signOut = signOut;
    window.getAuthToken = getAuthToken;
    window.isUserLoggedIn = isUserLoggedIn;
  </script>

  <script src="/js/main.js"></script>
</body>
</html>
